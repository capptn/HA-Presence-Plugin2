<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Anwesenheitssimulation</title>
    <style>
      body {
        font-family: sans-serif;
      }
      .row {
        display: flex;
        gap: 20px;
      }
      select {
        width: 280px;
        height: 35px;
      }
      ul {
        padding-left: 20px;
      }
      li {
        margin-bottom: 6px;
      }
    </style>
  </head>
  <body>
    <h2>Anwesenheitssimulation</h2>

    <div class="row">
      <div>
        <h4>Verf√ºgbare Entit√§ten</h4>
        <select id="available"></select
        ><br /><br />
        <button id="add">‚ûï Hinzuf√ºgen</button>
      </div>

      <div>
        <h4>Aktive Entit√§ten</h4>
        <ul id="active"></ul>
      </div>
    </div>

    <br />

    <button id="start">‚ñ∂ Start</button>
    <button id="stop">‚èπ Stop</button>

    <h3>Status</h3>
    <p id="status">‚Äì</p>

    <h3>N√§chste geplante Aktionen</h3>
    <ul id="preview"></ul>

    <h3>Aktions-Historie</h3>
    <table border="1" cellpadding="6">
      <thead>
        <tr>
          <th>Zeit</th>
          <th>Entit√§t</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody id="history"></tbody>
    </table>
    <div style="display: hidden">
      <h3>Balken-Timeline</h3>
      <div id="timeline"></div>
      <h3>Heatmap (Aktivit√§tsdichte)</h3>
      <div id="heatmap"></div>

      <style>
        .heat-row {
          display: flex;
          align-items: center;
          margin-bottom: 4px;
        }
        .heat-bar {
          height: 14px;
          margin-left: 8px;
          background: red;
        }
      </style>
    </div>
    <h3>Planungs-Einstellungen</h3>

    <label>
      Planungshorizont (Minuten):
      <input
        id="plan_horizon_minutes"
        type="number"
        min="60"
        step="30"
      /> </label
    ><br /><br />

    <label>
      Nachplanen, wenn weniger als (Minuten):
      <input
        id="refill_threshold_minutes"
        type="number"
        min="15"
        step="15"
      /> </label
    ><br /><br />

    <label>
      Sessions pro Entit√§t:
      <input id="sessions_per_entity" type="number" min="1" max="5" /> </label
    ><br /><br />

    <label>
      Slot-Gr√∂√üe (Minuten):
      <input id="slot_minutes" type="number" min="5" step="5" /> </label
    ><br /><br />

    <label>
      Lernzeitraum (Tage):
      <input id="lookback_days" type="number" min="3" step="1" /> </label
    ><br /><br />

    <button id="saveConfig">üíæ Einstellungen speichern</button>
    <style>
      .timeline-row {
        margin-bottom: 6px;
      }
      .bar {
        display: inline-block;
        height: 14px;
        margin-left: 6px;
      }
      .on {
        background: #ffd54f;
      }
      .off {
        background: #ccc;
      }
    </style>

    <script>
      let activeEntities = [];

      async function loadEntities() {
        const list = await fetch("api/entities").then((r) => r.json());
        const sel = document.getElementById("available");
        sel.innerHTML = "";

        list.forEach((e) => {
          const opt = document.createElement("option");
          opt.value = e.id;
          opt.textContent = e.name;
          sel.appendChild(opt);
        });
      }

      function renderActive() {
        const ul = document.getElementById("active");
        ul.innerHTML = "";

        activeEntities.forEach((id) => {
          const li = document.createElement("li");
          li.textContent = id + " ";
          const btn = document.createElement("button");
          btn.textContent = "‚úñ";
          btn.onclick = () => {
            activeEntities = activeEntities.filter((e) => e !== id);
            saveConfig();
          };
          li.appendChild(btn);
          ul.appendChild(li);
        });
      }

      async function saveConfig() {
        await fetch("api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ entities: activeEntities }),
        });
        renderActive();
      }

      document.getElementById("add").onclick = () => {
        const sel = document.getElementById("available");
        const id = sel.value;
        if (id && !activeEntities.includes(id)) {
          activeEntities.push(id);
          saveConfig();
        }
      };

      document.getElementById("start").onclick = async () => {
        await fetch("api/start", { method: "POST" });
        await loadStatus();
        //document.getElementById("status").innerText = "Simulation l√§uft ‚ñ∂";
      };

      document.getElementById("stop").onclick = async () => {
        await fetch("api/stop", { method: "POST" });
        await loadStatus();
        //document.getElementById("status").innerText = "Simulation gestoppt ‚èπ";
      };

      async function loadConfig() {
        config = await fetch("api/config").then((r) => r.json());

        // Entit√§ten (falls schon da)
        activeEntities = config.entities || [];
        renderActive();

        // Planner-Settings
        document.getElementById("plan_horizon_minutes").value =
          config.plan_horizon_minutes ?? 240;

        document.getElementById("refill_threshold_minutes").value =
          config.refill_threshold_minutes ?? 60;

        document.getElementById("sessions_per_entity").value =
          config.sessions_per_entity ?? 2;

        document.getElementById("slot_minutes").value =
          config.slot_minutes ?? 15;

        document.getElementById("lookback_days").value =
          config.lookback_days ?? 14;
      }

      document.getElementById("saveConfig").onclick = async () => {
        config.plan_horizon_minutes = parseInt(
          document.getElementById("plan_horizon_minutes").value
        );

        config.refill_threshold_minutes = parseInt(
          document.getElementById("refill_threshold_minutes").value
        );

        config.sessions_per_entity = parseInt(
          document.getElementById("sessions_per_entity").value
        );

        config.slot_minutes = parseInt(
          document.getElementById("slot_minutes").value
        );

        config.lookback_days = parseInt(
          document.getElementById("lookback_days").value
        );

        await fetch("api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(config),
        });

        document.getElementById("status").innerText =
          "Einstellungen gespeichert ‚úÖ (wirken beim n√§chsten Nachplanen)";
      };

      async function loadPreview() {
        const data = await fetch("api/preview").then((r) => r.json());
        const ul = document.getElementById("preview");
        ul.innerHTML = "";

        data.forEach((p) => {
          const li = document.createElement("li");
          const icon = p.action === "turn_on" ? "üí° AN" : "üåë AUS";
          li.textContent = `${p.time} ‚Äì ${p.entity} ‚Üí ${icon}`;
          ul.appendChild(li);
        });
      }
      async function loadTimeline() {
        const data = await fetch("api/timeline").then((r) => r.json());
        const div = document.getElementById("timeline");
        div.innerHTML = "";

        Object.keys(data).forEach((entity) => {
          const row = document.createElement("div");
          row.className = "timeline-row";
          row.innerHTML = `<strong>${entity}</strong>`;

          data[entity].forEach((a) => {
            const bar = document.createElement("span");
            bar.className = "bar " + (a.action === "turn_on" ? "on" : "off");
            bar.style.width = "30px";
            bar.title = `${a.time} ${a.action}`;
            row.appendChild(bar);
          });

          div.appendChild(row);
        });
      }
      async function loadHeatmap() {
        const data = await fetch("api/heatmap").then((r) => r.json());
        const div = document.getElementById("heatmap");
        div.innerHTML = "";

        data.forEach((h) => {
          const row = document.createElement("div");
          row.className = "heat-row";

          const label = document.createElement("span");
          label.textContent = h.time;

          const bar = document.createElement("div");
          bar.className = "heat-bar";
          bar.style.width = h.value * 25 + "px";
          bar.style.opacity = Math.min(1, h.value / 5);

          row.appendChild(label);
          row.appendChild(bar);
          div.appendChild(row);
        });
      }
      async function loadStatus() {
        const s = await fetch("api/status").then((r) => r.json());

        if (s.running) {
          document.getElementById("status").innerText =
            "Simulation l√§uft ‚ñ∂ (seit " + s.started_at + ")";
        } else {
          document.getElementById("status").innerText = "Simulation gestoppt ‚èπ";
        }
      }
      async function loadHistory() {
        const data = await fetch("api/history").then((r) => r.json());
        const tbody = document.getElementById("history");
        tbody.innerHTML = "";

        data.slice(0, 50).forEach((h) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
      <td>${h.time}</td>
      <td>${h.entity}</td>
      <td>${h.action === "turn_on" ? "üí° AN" : "üåë AUS"}</td>
    `;

          tbody.appendChild(tr);
        });
      }

      loadStatus();
      loadEntities();
      loadConfig();
      loadTimeline();
      loadHeatmap();
      loadPreview();
      loadHistory();
      setInterval(loadHeatmap, 5000);
      setInterval(loadPreview, 5000);
      setInterval(loadTimeline, 5000);
      setInterval(loadHistory, 5000);
    </script>
  </body>
</html>
